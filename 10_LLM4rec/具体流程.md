整个搜广推是一个**漏斗（Funnel）模型**：从海量物品中层层筛选，最终通过“混排”展示给用户。

我们把这个流程拆解为：**数据准备 (Embedding/Word2Vec) -> 召回 -> 粗排 -> 精排 -> 重排 -> 混排**。

---

### 0. 基础基石：Word2Vec 与 Embedding

**位置：** 在流程开始之前，这是“离线”做好的准备工作。

你说到的 **Word2Vec (2013, Google)** 是这一切的鼻祖。

* **原理：** 它的核心思想是 `King - Man + Woman = Queen`。在推荐系统中，我们把它魔改为 **Item2Vec**。
* **具体做法：**
* 把用户的一次浏览记录（序列）看作一句话：`[手机壳, 数据线, 充电宝, 蓝牙耳机]`。
* 把每一个商品看作一个单词。
* 扔进 Word2Vec 模型训练。
* **结果：** 每个商品都变成了一个向量（Vector）。“手机壳”和“数据线”在向量空间里的距离非常近。


* **作用：** 有了这些向量，我们在后续的“召回”阶段，算相似度就快得飞起（直接算两个向量的内积）。

---

### 1. 召回 (Recall/Match) —— 海选

**任务：** 从千万级/亿级商品库中，快速捞出几千个用户可能感兴趣的候选集（比如 Top 2000）。
**核心要求：** **速度快**（不能上复杂模型，算不过来）、**覆盖广**。

这一步通常是**多路召回**（Multi-channel Recall），即好几条路同时跑，最后把结果合在一起：

1. **热门召回 (Hot Recall)：** 兜底策略，谁都推点热门的。
2. **协同过滤召回 (CF Recall)：** 经典的 Item-based CF，买了A的人也买了B。
3. **向量召回 (Embedding-based Recall / I2I)：** **这是重头戏。**
* 利用上面 Word2Vec 算好的向量。
* 工具：**Faiss (Facebook)** 或 **Annoy (Spotify)**。
* 逻辑：用户最近看了 Item A，我在向量数据库里瞬间搜出和 Item A 距离最近的 100 个 Item。


4. **双塔召回 (DSSM / Two-Tower)：**
* 用户侧生成一个 User Vector，物品侧生成 Item Vector。
* 在线服务时，拿 User Vector 去库里搜最相似的 Item Vector。



**输出：** 比如说 5000 个乱七八糟的候选商品 ID。

---

### 2. 粗排 (Pre-ranking / Rough Sort) —— 初筛

**任务：** 把 5000 个砍到 500 个。
**核心要求：** 比召回准一点，比精排快一点。

**为什么要粗排？**
因为精排模型（DeepFM, DIN）太重了，几千个全算一遍延时会爆炸。

* **技术演进：**
* **早期：** 简单的逻辑回归 (LR) 或者 缩减版的双塔模型。
* **现在 (蒸馏技术)：** 用精排的大模型（Teacher）去教一个结构简单的粗排小模型（Student）。小模型虽然笨点，但算得快，学到了老师的一点皮毛用于初筛足够了。



**输出：** 500 个质量还不错的候选商品。

---

### 3. 精排 (Ranking / Fine Sort) —— 决战

**任务：** 把 500 个商品进行精确打分，算出 pCTR (预测点击率) 和 pCVR (预测转化率)。
**核心要求：** **极度精准**。这里是算力消耗的大头。

我们在上一条回复里讲的 **Wide&Deep, DeepFM, DIN, MMoE** 全部都在这一层工作。

* **输入：** 及其丰富的特征。
* 用户画像（年龄、性别...）
* 上下文（时间、Wifi/4G、手机型号...）
* 交叉特征（昨晚看了鞋子+今天是周末+现在是早上）


* **过程：** 模型对这 500 个商品每一个都进行复杂的神经网络计算。
* **输出：** 带有预测分数的列表。例如：`{商品A: 0.9, 商品B: 0.85, ...}`

---

### 4. 重排 (Re-ranking) —— 业务规则与多样性

**任务：** 对精排的前 50-100 名结果进行微调。
**核心要求：** 解决“信息茧房”和“用户体验”问题。

如果精排说用户喜欢“美女视频”，直接推100个美女视频，用户会腻死（Boredom），且违反生态规则。

* **核心技术：**
* **MMR (Maximal Marginal Relevance)：** 保证多样性。如果你第一位推了 iPhone，第二位就尽量别推 iPhone 了，推个 AirPods 或者 Mac，打散同类目。
* **规则过滤：** 剔除已曝光的（看过的别再推）、违规的。
* **List-wise 模型：** 现在的趋势。精排是 Point-wise（一个一个算分），重排是 List-wise（考虑一整屏的组合效益，比如“红花还要绿叶配”）。



**输出：** 优化后的有序列表。

---

### 5. 混排 (Mixing) —— 流量变现与生态

**任务：** 把“自然推荐内容”、“广告”、“直播卡片”、“活动运营”拼在一起。
**核心要求：** 赚钱与留人的平衡。

你刷抖音，每刷 5 条视频，必出 1 条广告。这就是混排决定的。

* **具体逻辑：**
* **固定坑位 (Fixed Slots)：** 规定第 3、8、13 位必须是广告。
* **动态混排 (Dynamic Mixing)：**
* 系统实时计算：如果这个广告的收益 (eCPM) 远大于自然视频带来的用户体验价值，就强行插入。
* 这涉及到一个著名的公式：`Rank Score = pCTR * Bid（出价）`。
* 现在的强化学习 (RL) 经常用在这里，根据用户当下的心情（是否急躁），决定敢不敢插广告。





**最终输出：** 用户手机屏幕上看到的那一屏内容。

---

### 总结：数据流转全景图

假设你打开淘宝首页，后台发生了什么：

1. **[离线] Word2Vec/Graph Embedding：** 把几亿商品变成了向量库，存好。
2. **[召回]：** 系统发现你最近看了“键盘”。
* Item-CF 路：找“买键盘的人还买过啥” -> 鼠标。
* Vector 路：找“键盘向量”最近的邻居 -> 显示器。
* 凑齐 5000 个商品。


3. **[粗排]：** 用轻量模型快速扫一眼，剔除 4500 个明显不靠谱的，剩 500 个。
4. **[精排]：** 上 DeepFM/DIN 大模型。发现你虽然召回了“鼠标”，但根据你现在的行为序列，你其实更想买“电竞椅”。给电竞椅打高分。
5. **[重排]：** 发现前 5 名全是电竞椅。MMR 算法介入，强行打散，插进去一个“机械键盘”和“零食”，保证多样性。
6. **[混排]：** 广告系统介入。发现你价值很高，在第 4 位插入一个“某品牌电脑”的广告。
7. **[展示]：** 你的手机刷出了这串列表。
